<!doctype html><html lang=ja><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="ç§ãŒ Mastodon ã‚’ç«‹ã¡ä¸Šã’ã‚‹ã¨ãã«ä½¿ã£ãŸãƒ¡ãƒ¢ã§ã™ã€‚ã‚ãã¾ã§è‡ªåˆ†ç”¨ãªã®ã§ã‚ã‹ã‚Šã«ãã„éƒ¨åˆ†ãŒã‚ã‚‹ã¨æ€ã„ã¾ã™ãŒæ”¹å–„ã—ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ã€‚ ã¡ãªã¿ã«æ§‹ç¯‰ã—ãŸç’°å¢ƒ"><title>Mastodon ã‚’è§¦ã£ãŸã¨ãã®ãƒ¡ãƒ¢</title><link rel=canonical href=https://www.39.gy/post/mastodon/><link rel=stylesheet href=/scss/style.min.css><meta property="og:title" content="Mastodon ã‚’è§¦ã£ãŸã¨ãã®ãƒ¡ãƒ¢"><meta property="og:description" content="ç§ãŒ Mastodon ã‚’ç«‹ã¡ä¸Šã’ã‚‹ã¨ãã«ä½¿ã£ãŸãƒ¡ãƒ¢ã§ã™ã€‚ã‚ãã¾ã§è‡ªåˆ†ç”¨ãªã®ã§ã‚ã‹ã‚Šã«ãã„éƒ¨åˆ†ãŒã‚ã‚‹ã¨æ€ã„ã¾ã™ãŒæ”¹å–„ã—ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ã€‚ ã¡ãªã¿ã«æ§‹ç¯‰ã—ãŸç’°å¢ƒ"><meta property="og:url" content="https://www.39.gy/post/mastodon/"><meta property="og:site_name" content="39.gy"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="Mastodon"><meta property="article:tag" content="CentOS"><meta property="article:tag" content="Docker"><meta property="article:published_time" content="2017-05-24T12:00:00+09:00"><meta property="article:modified_time" content="2020-10-09T04:18:52+00:00"><meta property="og:image" content="https://res.cloudinary.com/dagsofv2s/image/upload/q_auto:good/blog/post/mastodon/thumbnail.png"><meta name=twitter:site content="@ress997"><meta name=twitter:title content="Mastodon ã‚’è§¦ã£ãŸã¨ãã®ãƒ¡ãƒ¢"><meta name=twitter:description content="ç§ãŒ Mastodon ã‚’ç«‹ã¡ä¸Šã’ã‚‹ã¨ãã«ä½¿ã£ãŸãƒ¡ãƒ¢ã§ã™ã€‚ã‚ãã¾ã§è‡ªåˆ†ç”¨ãªã®ã§ã‚ã‹ã‚Šã«ãã„éƒ¨åˆ†ãŒã‚ã‚‹ã¨æ€ã„ã¾ã™ãŒæ”¹å–„ã—ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ã€‚ ã¡ãªã¿ã«æ§‹ç¯‰ã—ãŸç’°å¢ƒ"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://res.cloudinary.com/dagsofv2s/image/upload/q_auto:good/blog/post/mastodon/thumbnail.png"></head><body><div class="container flex on-phone--column align-items--flex-start extended article-page with-toolbar"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header class=site-info><figure class=site-avatar><img src=/img/avatar_hua3d9c57f11aa6bec7822838cfcfce9d1_118733_300x300_resize_box_2.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
<span class=emoji>ğŸ¦‹</span></figure><h1 class=site-name><a href=https://www.39.gy/>39.gy</a></h1><h2 class=site-description>noob ã‹ã‚‰ hacker ã«ãªã‚ŠãŸã„</h2></header><ol class=menu id=main-menu><li><a href=https://www.39.gy/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=https://www.39.gy/about><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>About</span></a></li><li><a href=https://www.39.gy/archives><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li></ol></aside><main class="main full-width"><div id=article-toolbar><a href=https://www.39.gy/ class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg><span>Back</span></a></div><article class="has-image main-article"><header class=article-header><div class=article-image><img src=https://res.cloudinary.com/dagsofv2s/image/upload/q_auto:good/blog/post/mastodon/thumbnail.png loading=lazy alt="Featured image of post Mastodon ã‚’è§¦ã£ãŸã¨ãã®ãƒ¡ãƒ¢"></div><div class=article-details><header class=article-category><a href=https://www.39.gy/categories/tech/>Tech</a></header><h2 class=article-title><a href=https://www.39.gy/post/mastodon/>Mastodon ã‚’è§¦ã£ãŸã¨ãã®ãƒ¡ãƒ¢</a></h2><footer class=article-time><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--published>May 24, 2017</time></footer></div></header><section class=article-content><p>ç§ãŒ Mastodon ã‚’ç«‹ã¡ä¸Šã’ã‚‹ã¨ãã«ä½¿ã£ãŸãƒ¡ãƒ¢ã§ã™ã€‚ã‚ãã¾ã§è‡ªåˆ†ç”¨ãªã®ã§ã‚ã‹ã‚Šã«ãã„éƒ¨åˆ†ãŒã‚ã‚‹ã¨æ€ã„ã¾ã™ãŒæ”¹å–„ã—ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ã€‚</p><p>ã¡ãªã¿ã«æ§‹ç¯‰ã—ãŸç’°å¢ƒã¯ CentOS 7.2 + Nginx + Docker ã§ã™ã€‚</p><h2 id=preparation>Preparation</h2><p>äº‹å‰ã«å¿…è¦ãã†ãªè¨­å®šã‚’è¡Œã£ã¦ã„ãã¾ã™ã€‚</p><h3 id=firewall>Firewall</h3><p>ãƒ•ã‚¡ã‚¤ãƒ¤ãƒ¼ã‚¦ã‚©ãƒ¼ãƒ«ã®è¨­å®šã‚’ã—ã¦ã„ãã¾ã™ã€‚</p><p>ç¾åœ¨ã®è¨­å®šã‚’ç¢ºèªã—ã¾ã™ã€‚</p><pre><code>firewall-cmd --list-all
</code></pre><p>dmzã‚¾ãƒ¼ãƒ³ ã‚’ defaultè¨­å®š ã«å¤‰æ›´ã—ã¾ã™ã€‚</p><pre><code>firewall-cmd --set-default-zone=dmz
</code></pre><p>æ¬¡ã«NICã¸å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ã‚‹ã‚¾ãƒ¼ãƒ³ã®å¤‰æ›´ã—ã¾ã™ã€‚
<code>/etc/sysconfig/network-scripts/ifcfg-eth0</code> ã®æœ€çµ‚è¡Œã« <code>ZONE=dmz</code> ã‚’è¿½åŠ ã—ãŸã ã‘ã§ã™ã€‚</p><pre><code class=language-diff:/etc/sysconfig/network-scripts/ifcfg-eth0 data-lang=diff:/etc/sysconfig/network-scripts/ifcfg-eth0>+ ZONE=dmz
</code></pre><p>http ã¨ https ç”¨ã®ãƒãƒ¼ãƒˆã‚’é–‹ã‘è¨­å®šã‚’èª­ã¿è¾¼ã¾ã›ã¾ã™ã€‚
<code>--permanent</code> ã‚’ã¤ã‘ã‚‹ã“ã¨ã«ã‚ˆã£ã¦æ°¸ç¶šåŒ–ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>firewall-cmd --permanent --add-service<span style=color:#f92672>=</span>http
firewall-cmd --permanent --add-service<span style=color:#f92672>=</span>https
firewall-cmd --reload
</code></pre></div><h3 id=swap-é ˜åŸŸ>Swap é ˜åŸŸ</h3><p>ç§ãŒå€Ÿã‚ŠãŸã‚µãƒ¼ãƒãƒ¼ã¯ãƒ¡ãƒ¢ãƒªãŒ 1GB ã¨è²§å¼±ãªã®ã§ Swap é ˜åŸŸã‚’ 4G è¨­å®šã—ã¾ã—ãŸã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>dd <span style=color:#66d9ef>if</span><span style=color:#f92672>=</span>/dev/zero of<span style=color:#f92672>=</span>/swapfile bs<span style=color:#f92672>=</span>1M count<span style=color:#f92672>=</span><span style=color:#ae81ff>4096</span>
chmod <span style=color:#ae81ff>600</span> /swapfile
mkswap /swapfile
swapon /swapfile
</code></pre></div><h2 id=install--setting>Install ï½¥ Setting</h2><p>å¿…è¦ãªã‚‚ã®ã‚’ã©ã‚“ã©ã‚“ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ãã¾ã™ã€‚</p><h3 id=certbot>Certbot</h3><p>SSLè¨¼æ˜æ›¸(Letâ€™s Encrypt ) ã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚½ãƒ•ãƒˆã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™
<a class=link href=https://certbot.eff.org/#centosrhel7-nginx target=_blank rel=noopener>ã“ã“</a> ã‚’å‚è€ƒã«ã—ã¾ã—ãŸã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>yum -y install yum-utils
yum-config-manager --enable rhui-REGION-rhel-server-<span style=color:#f92672>{</span>extras,optional<span style=color:#f92672>}</span>
yum -y install certbot
</code></pre></div><p>ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒçµ‚ã‚ã£ãŸã‚‰ SSLè¨¼æ˜æ›¸ã‚’ç™ºè¡Œã—ã¾ã™ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>certbot certonly --standalone -d example.com --rsa-key-size <span style=color:#ae81ff>4096</span>
</code></pre></div><h3 id=nginx>Nginx</h3><p>å…¬é–‹ã™ã‚‹ãŸã‚ã« Web ã‚µãƒ¼ãƒãƒ¼ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
<a class=link href=https://www.nginx.com/resources/wiki/start/topics/tutorials/install/#official-red-hat-centos-packages target=_blank rel=noopener>ã“ã“</a> ã‚’å‚è€ƒã«ã—ã¾ã—ãŸã€‚</p><p>ã¾ãšæœ€æ–°ç‰ˆã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ãŸã‚ã«è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚</p><pre><code class=language-:/etc/yum.repos.d/nginx.repo data-lang=:/etc/yum.repos.d/nginx.repo>[nginx]
name=nginx repo
baseurl=http://nginx.org/packages/centos/7/$basearch/
gpgcheck=0
enabled=1
</code></pre><p>ãã—ã¦æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å…¥åŠ›ã—ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>yum -y --enablerepo<span style=color:#f92672>=</span>nginx install nginx
</code></pre></div><p>æœ€å¾Œã«ã€ Nginx ã®èµ·å‹•ã¨ã‚µãƒ¼ãƒã®å†èµ·å‹•ãŒè¡Œã‚ã‚ŒãŸå ´åˆã§ã‚‚è‡ªå‹•ã§èµ·å‹•ã•ã‚Œã‚‹ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>systemctl enable nginx
systemctl start nginx
</code></pre></div><h3 id=docker>Docker</h3><p>Mastodon ã‚’ç°¡å˜ã«å‹•ã‹ã™ãŸã‚ã«ä»®æƒ³åŒ–ã‚½ãƒ•ãƒˆã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
<a class=link href=https://docs.docker.com/engine/installation/linux/centos/#docker-ce target=_blank rel=noopener>ã“ã“</a> ã‚’å‚è€ƒã«ã—ã¾ã—ãŸã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
yum -y install docker-ce
</code></pre></div><p>Docker ã®èµ·å‹•ã¨ã‚µãƒ¼ãƒã®å†èµ·å‹•ãŒè¡Œã‚ã‚ŒãŸå ´åˆã§ã‚‚è‡ªå‹•ã§èµ·å‹•ã•ã‚Œã‚‹ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>systemctl enable docker
systemctl start docker
</code></pre></div><h4 id=docker-compose>Docker Compose</h4><p>è¤‡æ•°ã®ã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰ãªã‚‹ã‚µãƒ¼ãƒ“ã‚¹ (ã“ã“ã§ã¯ Mastodon ã®ã“ã¨ã§ã™) ã‚’ç°¡å˜ã«æ“ä½œã§ãã‚‹ã‚ˆã†ã« Docker Compose ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
<a class=link href=https://docs.docker.com/compose/install/ target=_blank rel=noopener>ã“ã“</a> ã‚’å‚è€ƒã«ã—ã¾ã—ãŸã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl -L https://github.com/docker/compose/releases/download/1.14.0/docker-compose-<span style=color:#66d9ef>$(</span>uname -s<span style=color:#66d9ef>)</span>-<span style=color:#66d9ef>$(</span>uname -m<span style=color:#66d9ef>)</span> &gt; /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose
</code></pre></div><p>Docker Compose ãŒå‹•ãã‹ç¢ºèªã—ã¾ã™ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker-compose --version
</code></pre></div><h3 id=mastodon>Mastodon</h3><p><a class=link href=https://github.com/tootsuite/documentation/blob/master/Running-Mastodon/Docker-Guide.md target=_blank rel=noopener>ã“ã“</a> ã‚’å‚è€ƒã«ã—ã¾ã—ãŸã€‚
ä»Šå›ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ <code>/var/www/mstdn</code> ã¨ã—ã¾ã™ã€‚</p><p>ã¾ãšã€æ“ä½œã™ã‚‹ãŸã‚ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã¾ã™</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>useradd --system --user-group --shell /bin/false --create-home --home /home/mastodon mastodon
passwd mastodon
</code></pre></div><p>Mastodonã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å ´æ‰€ã‚’ç”¨æ„ã—æ‰€æœ‰è€…ã‚’å¤‰æ›´ã—ã¾ã™ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mkdir -p /var/www/mstdn
chown -R mastodon /var/www/mstdn
</code></pre></div><p>ã“ã“ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å¤‰ãˆã¦Mastodonã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>su - mastodon
cd /var/www
git clone https://github.com/tootsuite/mastodon.git mstdn
cd /var/www/mstdn
sudo docker-compose build
</code></pre></div><p>è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦æ›¸ãæ›ãˆã¦ã„ãã¾ã™ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cp .env.production.sample .env.production
</code></pre></div><p>3å›ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ã‚’ç”Ÿæˆã—ãƒ¡ãƒ¢ã‚’å–ã‚Šã¾ã™ã€‚
ç”Ÿæˆã—ãŸã®ã¯ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ã¯ <code>PAPERCLIP_SECRET</code> ã¨ <code>SECRET_KEY_BASE</code> ã¨ <code>OTP_SECRET</code> ã®éƒ¨åˆ†ã‚’æ›¸ãç›´ã—ã¾ã™ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo docker-compose run --rm web rake secret
</code></pre></div><p>ã‚ã¨ã¯å¿…è¦ã«å¿œã˜ã¦ <code>LOCAL_DOMAIN</code> ã‚„ <code>SMTP_*</code> ã®éƒ¨åˆ†ã‚’æ›¸ãç›´ã—ã¾ã™ã€‚</p><p>Mastodonã‚’ä½¿ç”¨ã—ã¦æ„Ÿã˜ãŸã®ã¯ã€è‡ªã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒªãƒ¢ãƒ¼ãƒˆãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã‚‹äººãŒæŠ•ç¨¿ã—ãŸç”»åƒã‚‚è‡ªåˆ†ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ä¿å­˜ã•ã‚Œã‚‹ã®ã§çµµå¸«ãªã©ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã‚‹ã¨ã™ãã«å®¹é‡ãŒãªããªã‚Šã¾ã™ã€‚ãªã®ã§S3ã®é …ç›®ã‚‚è¨­å®šã—ãŸæ–¹ãŒãŠã™ã™ã‚ã§ã™ã€‚</p><pre><code class=language-zsh:.env.production(è¨­å®šä¾‹) data-lang=zsh:.env.production(è¨­å®šä¾‹)># S3 (optional)
S3_ENABLED=true
S3_BUCKET=&lt;ãƒã‚±ãƒƒãƒˆå&gt;
AWS_ACCESS_KEY_ID=&lt;AWSã®ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼&gt;
AWS_SECRET_ACCESS_KEY=&lt;AWSã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼&gt;
S3_REGION=ap-northeast-1
S3_PROTOCOL=https
S3_HOSTNAME=https://ap-northeast-1.amazonaws.com

# Optional alias for S3 if you want to use Cloudfront or Cloudflare in front
S3_CLOUDFRONT_HOST=&lt;S3ã®ãƒã‚±ãƒƒãƒˆãƒ‰ãƒ¡ã‚¤ãƒ³ã‹CDNã®ãƒ‰ãƒ¡ã‚¤ãƒ³&gt;
</code></pre><p>ã“ã®ã¾ã¾Dockerã‚’èµ·å‹•ã™ã‚‹ã¨ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆãˆã‚‹ã®ã§ <code>docker-compose.yml</code> ã‚’ç·¨é›†ã—ã¾ã™ã€‚
<code>Uncomment to enable ...</code>ã¨æ›¸ã„ã¦ã‚ã‚‹ä¸‹ã®<code>volumes</code>ã®éƒ¨åˆ†ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ã¾ã™ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff:docker-compose.yml data-lang=diff:docker-compose.yml> <span style=color:#75715e>### Uncomment to enable DB persistance</span>
<span style=color:#f92672>-#    volumes</span>:
-<span style=color:#75715e>#      - ./postgres:/var/lib/postgresql/data</span>
<span style=color:#f92672>+    volumes</span>:
<span style=color:#ae81ff>+      - ./postgres:/var/lib/postgresql/data</span>
 
   <span style=color:#f92672>redis</span>:
     <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
     <span style=color:#f92672>image</span>: <span style=color:#ae81ff>redis:alpine</span>
 <span style=color:#75715e>### Uncomment to enable REDIS persistance</span>
<span style=color:#f92672>-#    volumes</span>:
-<span style=color:#75715e>#      - ./redis:/data</span>
<span style=color:#f92672>+    volumes</span>:
<span style=color:#ae81ff>+      - ./redis:/data</span>
</code></pre></div><h4 id=postgresql-ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å›ºå®šåŒ–>PostgreSQL ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å›ºå®šåŒ–</h4><p>ã“ã®ã¾ã¾ã§ã¯ PostgreSQL ã®ãƒ¡ã‚¤ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã•ã‚Œã‚‹ã¨ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ä½œæ¥­ã‚’ã™ã‚‹å¿…è¦ãŒç™ºç”Ÿã™ã‚‹ã®ã§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å›ºå®šã—ã¾ã™ã€‚
(<a class=link href=http://cryks.hateblo.jp/entry/2017/04/16/145547 target=_blank rel=noopener>ã“ã“</a> ã‚’å‚è€ƒã«ã—ã¾ã—ãŸ)</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff:docker-compose.yml data-lang=diff:docker-compose.yml>-    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>postgres:alpine</span>
<span style=color:#f92672>+    image</span>: <span style=color:#ae81ff>postgres:9.6-alpin</span>
</code></pre></div><h4 id=sidekiq-ã‚’å†—é•·åŒ–ã™ã‚‹-ã‚ªãƒ—ã‚·ãƒ§ãƒ³>Sidekiq ã‚’å†—é•·åŒ–ã™ã‚‹ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)</h4><p>Pawoo.net ã‚’é‹ç”¨ã—ã¦ã‚‹ pixiv ã§ <a class=link href=https://inside.pixiv.blog/harukasan/1284 target=_blank rel=noopener>å®Ÿéš›ã«é‹ç”¨ã—ã¦ã¿ã¦ã‚ã‹ã£ãŸã€å¤§è¦æ¨¡Mastodonã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’é‹ç”¨ã™ã‚‹ã‚³ãƒ„</a> ã¨ã„ã†è¨˜äº‹ã‚’è¦‹ã¤ã‘èª­ã¿ã¾ã—ãŸã€‚</p><blockquote><p>ã“ã®ã†ã¡pushã€pullã®ã‚­ãƒ¥ãƒ¼ã¯ä»–ã®Mastodonã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®APIã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€ã»ã‹ã®Mastodonã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒå¿œç­”ã§ããªã„çŠ¶æ…‹ã«é™¥ã£ã¦ã„ã‚‹ã¨ã‹ãªã‚Šã®ã‚­ãƒ¥ãƒ¼ãŒè©°ã¾ã‚Œã¦ã—ã¾ã„ã€defaultã‚­ãƒ¥ãƒ¼ã®å‡¦ç†ã‚‚é…å»¶ã•ã›ã¦ã—ã¾ã„ã¾ã™ã€‚</p></blockquote><p>ã¨ã‚ã‚Šå…·ä½“çš„ãªè§£æ±ºç­–ã¨ã—ã¦ <strong>Sidekiqã®ãƒ—ãƒ­ã‚»ã‚¹æ•°ã‚’å¢—ã‚„ã™</strong> ã¨æ›¸ã„ã¦ã‚ã£ãŸã®ã§Dockerã‚’è¤‡æ•°ç«‹ã¦ã¦å¯¾å¿œã—ã¦è¦‹ã¾ã—ãŸã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml:docker-compose.yml data-lang=yaml:docker-compose.yml>  <span style=color:#f92672>sidekiq-default</span>:
    <span style=color:#f92672>build</span>: <span style=color:#ae81ff>.</span>
    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>gargron/mastodon</span>
    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
    <span style=color:#f92672>env_file</span>: <span style=color:#ae81ff>.env.production</span>
    <span style=color:#f92672>command</span>: <span style=color:#ae81ff>bundle exec sidekiq -c 20 -q default</span>
    <span style=color:#f92672>depends_on</span>:
      - <span style=color:#ae81ff>db</span>
      - <span style=color:#ae81ff>redis</span>
    <span style=color:#f92672>volumes</span>:
      - <span style=color:#ae81ff>./public/system:/mastodon/public/system</span>

  <span style=color:#f92672>sidekiq-maile</span>:
    <span style=color:#f92672>build</span>: <span style=color:#ae81ff>.</span>
    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>gargron/mastodon</span>
    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
    <span style=color:#f92672>env_file</span>: <span style=color:#ae81ff>.env.production</span>
    <span style=color:#f92672>command</span>: <span style=color:#ae81ff>bundle exec sidekiq -c 5 -q mailers</span>
    <span style=color:#f92672>depends_on</span>:
      - <span style=color:#ae81ff>db</span>
      - <span style=color:#ae81ff>redis</span>
    <span style=color:#f92672>volumes</span>:
      - <span style=color:#ae81ff>./public/system:/mastodon/public/system</span>

  <span style=color:#f92672>sidekiq-pull</span>:
    <span style=color:#f92672>build</span>: <span style=color:#ae81ff>.</span>
    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>gargron/mastodon</span>
    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
    <span style=color:#f92672>env_file</span>: <span style=color:#ae81ff>.env.production</span>
    <span style=color:#f92672>command</span>: <span style=color:#ae81ff>bundle exec sidekiq -c 10 -q pull</span>
    <span style=color:#f92672>depends_on</span>:
      - <span style=color:#ae81ff>db</span>
      - <span style=color:#ae81ff>redis</span>
    <span style=color:#f92672>volumes</span>:
      - <span style=color:#ae81ff>./public/system:/mastodon/public/system</span>

  <span style=color:#f92672>sidekiq-push</span>:
    <span style=color:#f92672>build</span>: <span style=color:#ae81ff>.</span>
    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>gargron/mastodon</span>
    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
    <span style=color:#f92672>env_file</span>: <span style=color:#ae81ff>.env.production</span>
    <span style=color:#f92672>command</span>: <span style=color:#ae81ff>bundle exec sidekiq -c 15 -q push</span>
    <span style=color:#f92672>depends_on</span>:
      - <span style=color:#ae81ff>db</span>
      - <span style=color:#ae81ff>redis</span>
    <span style=color:#f92672>volumes</span>:
      - <span style=color:#ae81ff>./public/system:/mastodon/public/system</span>
</code></pre></div><h3 id=ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—>ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</h3><p>ä¸‹è¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚„å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’è¡Œã„ã¾ã™ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo docker-compose run --rm web rails db:setup
sudo docker-compose run --rm web rails assets:precompile
</code></pre></div><p>æœ€å¾Œã«Mastodonã‚’èµ·å‹•ã•ã›ã¾ã™</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo docker-compose up -d
</code></pre></div><p>ã“ã‚Œã§ãƒ­ãƒ¼ã‚«ãƒ«ã« Mastodon ã‚’å»ºã¦ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚</p><h4 id=nginx-ã®è¨­å®š>Nginx ã®è¨­å®š</h4><p>Mastodonã‚’å¤–éƒ¨ã«å…¬é–‹ã™ã‚‹ãŸã‚ã«Webã‚µãƒ¼ãƒãƒ¼ã®è¨­å®šã‚’ã—ã¾ã™ã€‚
<a class=link href=https://git.io/v9AaO target=_blank rel=noopener>ã“ã“</a> ã‚’å‚è€ƒã« <code>/etc/nginx/conf.d/mastodon.conf</code> ã‚’ä½œæˆã—ã¾ã—ãŸã€‚</p><p>HSTS ã®è¨­å®šã‚’è¿½è¨˜ã—ã¾ã™ã€‚</p><pre><code class=language-diff:/etc/nginx/conf.d/mastodon.conf data-lang=diff:/etc/nginx/conf.d/mastodon.conf>-	add_header Strict-Transport-Security &quot;max-age=31536000&quot;;
+	add_header Strict-Transport-Security &quot;max-age=31536000; includeSubDomains; preload&quot;;
</code></pre><p>ã“ã®ã¾ã¾èµ·å‹•ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ <code>ssl_dhparam</code> ã§æŒ‡å®šã—ã¦ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„ã¨æ€’ã‚‰ã‚Œã‚‹ã®ã§ä½œæˆã—ã¾ã™ã€‚
ç’°å¢ƒã«ã‚ˆã£ã¦ã¯ã™ã”ã„æ™‚é–“ãŒã‹ã‹ã‚‹ã®ã§æ³¨æ„ã—ã¦ãã ã•ã„ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo openssl dhparam -out /etc/ssl/certs/dhparam.pem <span style=color:#ae81ff>4096</span>
</code></pre></div><p>Nginxã¨å¿µã®ç‚ºã«Mastodonã‚’å†èµ·å‹•ã•ã›ãŸã‚‰å®Œäº†ã§ã™</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo docker-compose restart
sudo systemctl restart nginx
</code></pre></div><p>ãŠç–²ã‚Œæ§˜ã§ã™ã€‚ã“ã‚Œã§ã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¦ã‚‹ã“ã¨ãŒã§ããŸã¨æ€ã„ã¾ã™ã€‚</p><h2 id=update>Update</h2><ol><li>ãƒªãƒ¢ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã®æœ€æ–°ã®å±¥æ­´ã®å–å¾—ã—ã¾ã™ã€‚<ul><li><code>git fetch --tags</code></li></ul></li><li>æœ€æ–°ã®Tagã«å¤‰æ›´ã™ã‚‹ (ä¾‹: v1.6.1 ã«ã™ã‚‹å ´åˆ)<ul><li><code>git checkout v1.6.1</code></li></ul></li><li>ç¢ºèª<ul><li><code>git status</code></li></ul></li><li>ãƒ“ãƒ«ãƒ‰<ul><li><code>docker-compose build</code></li></ul></li><li>DB (Option)<ul><li><code>docker-compose run --rm web rake db:migrate</code></li></ul></li><li>(Option)<ul><li><code>docker-compose run --rm web rake assets:precompile</code></li></ul></li><li>å†èµ·å‹•<ul><li><code>docker-compose up -d</code></li></ul></li></ol><p>ã“ã‚Œã§å†èµ·å‹•ãŒã§ãã¦ã‚‹ã¨æ€ã‚ã‚Œã¾ã™ã€‚</p><h2 id=ã•ã„ã”ã«>ã•ã„ã”ã«</h2><p>è‰²ã€…ã¨æ›¸ãã¾ã—ãŸãŒä»Šã¯é•ã†æ§‹æˆã‚’ã—ã¦ãŸã‚Šã—ã¦ã‚‹ã®ã§ã‚ãã¾ã§ã‚‚å‚è€ƒç¨‹åº¦ã«ãŠé¡˜ã„ã—ã¾ã™ã€‚</p></section><footer class=article-footer><section class=article-tags><a href=https://www.39.gy/tags/mastodon/>Mastodon</a>
<a href=https://www.39.gy/tags/centos/>Cent o s</a>
<a href=https://www.39.gy/tags/docker/>Docker</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section><section class=article-time><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><span class=article-time--modified></span></section></footer></article><aside class="widget related-contents--wrapper"><h1 class=widget-title>Related contents</h1><div class=related-contents><div class="flex article-list--tile"><article class=has-image><a href=https://www.39.gy/post/docker-secure/><div class=article-image><img src=https://res.cloudinary.com/dagsofv2s/image/upload/q_auto:good/blog/post/docker-secure/thumbnail.png loading=lazy data-key data-hash=https://res.cloudinary.com/dagsofv2s/image/upload/q_auto:good/blog/post/docker-secure/thumbnail.png></div><div class=article-details><h2 class=article-title>Docker ã‚’ã‚»ã‚­ãƒ¥ã‚¢ã«ä½¿ã†ãŸã‚ã«</h2></div></a></article><article class=has-image><a href=https://www.39.gy/post/mastodon-customize/><div class=article-image><img src=https://res.cloudinary.com/dagsofv2s/image/upload/q_auto:good/blog/post/mastodon-customize/thumbnail.png loading=lazy data-key data-hash=https://res.cloudinary.com/dagsofv2s/image/upload/q_auto:good/blog/post/mastodon-customize/thumbnail.png></div><div class=article-details><h2 class=article-title>Mastodon ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹</h2></div></a></article><article class=has-image><a href=https://www.39.gy/post/mastodon-conoha/><div class=article-image><img src=https://res.cloudinary.com/dagsofv2s/image/upload/q_auto:good/blog/post/mastodon-conoha/thumbnail.png loading=lazy data-key data-hash=https://res.cloudinary.com/dagsofv2s/image/upload/q_auto:good/blog/post/mastodon-conoha/thumbnail.png></div><div class=article-details><h2 class=article-title>ConoHa ã§ Mastodon ã‚’ç«‹ã¦ã¦ã¿ãŸ (ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½¿ç”¨)</h2></div></a></article><article class=has-image><a href=https://www.39.gy/post/ci-chenge/><div class=article-image><img src=https://res.cloudinary.com/dagsofv2s/image/upload/q_auto:good/blog/post/ci-chenge/thumbnail.png loading=lazy data-key data-hash=https://res.cloudinary.com/dagsofv2s/image/upload/q_auto:good/blog/post/ci-chenge/thumbnail.png></div><div class=article-details><h2 class=article-title>ãƒ–ãƒ­ã‚°ã®ãƒ“ãƒ«ãƒ‰ã‚’CircleCIã‹ã‚‰GitHub Actionsã«å¤‰æ›´ã—ãŸ</h2></div></a></article><article class=has-image><a href=https://www.39.gy/post/paclist-v1/><div class=article-image><img src=https://res.cloudinary.com/dagsofv2s/image/upload/q_auto:good/blog/post/paclist-v1/thumbnail.png loading=lazy data-key data-hash=https://res.cloudinary.com/dagsofv2s/image/upload/q_auto:good/blog/post/paclist-v1/thumbnail.png></div><div class=article-details><h2 class=article-title>Arch Linux ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’é¸å®šã—ãŸ</h2></div></a></article></div></div></aside><script src=https://utteranc.es/client.js repo=ress997/blog-comment issue-term=pathname theme=preferred-color-scheme crossorigin=anonymous async></script><style>.utterances{max-width:unset}</style><footer class=site-footer><section class=copyright>&copy; 2020 39.gy</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=1.0.4>Stack</a></b> designed by
<a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true style=display:none><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const customFont=document.createElement('link');customFont.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";customFont.type="text/css";customFont.rel="stylesheet";document.head.appendChild(customFont);}());</script><link rel=stylesheet href=/css/highlight/light.min.css media="(prefers-color-scheme: light)"><link rel=stylesheet href=/css/highlight/dark.min.css media="(prefers-color-scheme: dark)"></body></html>