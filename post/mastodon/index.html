<!doctype html><html lang=ja><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="私が Mastodon を立ち上げるときに使ったメモです。あくまで自分用なのでわかりにくい部分があると思いますが改善していこうと思います。 ちなみに構築した環境"><title>Mastodon を触ったときのメモ</title><link rel=canonical href=https://www.39.gy/post/mastodon/><link rel=stylesheet href=/scss/style.min.css><meta property="og:title" content="Mastodon を触ったときのメモ"><meta property="og:description" content="私が Mastodon を立ち上げるときに使ったメモです。あくまで自分用なのでわかりにくい部分があると思いますが改善していこうと思います。 ちなみに構築した環境"><meta property="og:url" content="https://www.39.gy/post/mastodon/"><meta property="og:site_name" content="39.gy"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="Mastodon"><meta property="article:tag" content="CentOS"><meta property="article:tag" content="Docker"><meta property="article:published_time" content="2017-05-24T12:00:00+09:00"><meta property="article:modified_time" content="2020-10-09T04:18:52+00:00"><meta property="og:image" content="https://res.cloudinary.com/dagsofv2s/image/upload/q_auto:good/blog/post/mastodon/thumbnail.png"><meta name=twitter:site content="@ress997"><meta name=twitter:title content="Mastodon を触ったときのメモ"><meta name=twitter:description content="私が Mastodon を立ち上げるときに使ったメモです。あくまで自分用なのでわかりにくい部分があると思いますが改善していこうと思います。 ちなみに構築した環境"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://res.cloudinary.com/dagsofv2s/image/upload/q_auto:good/blog/post/mastodon/thumbnail.png"></head><body><div class="container flex on-phone--column align-items--flex-start extended article-page with-toolbar"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header class=site-info><figure class=site-avatar><img src=/img/avatar_hua3d9c57f11aa6bec7822838cfcfce9d1_118733_300x300_resize_box_2.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
<span class=emoji>🦋</span></figure><h1 class=site-name><a href=https://www.39.gy/>39.gy</a></h1><h2 class=site-description>noob から hacker になりたい</h2></header><ol class=menu id=main-menu><li><a href=https://www.39.gy/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=https://www.39.gy/about><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>About</span></a></li><li><a href=https://www.39.gy/archives><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li></ol></aside><main class="main full-width"><div id=article-toolbar><a href=https://www.39.gy/ class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg><span>Back</span></a></div><article class="has-image main-article"><header class=article-header><div class=article-image><img src=https://res.cloudinary.com/dagsofv2s/image/upload/q_auto:good/blog/post/mastodon/thumbnail.png loading=lazy alt="Featured image of post Mastodon を触ったときのメモ"></div><div class=article-details><header class=article-category><a href=https://www.39.gy/categories/tech/>Tech</a></header><h2 class=article-title><a href=https://www.39.gy/post/mastodon/>Mastodon を触ったときのメモ</a></h2><footer class=article-time><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--published>May 24, 2017</time></footer></div></header><section class=article-content><p>私が Mastodon を立ち上げるときに使ったメモです。あくまで自分用なのでわかりにくい部分があると思いますが改善していこうと思います。</p><p>ちなみに構築した環境は CentOS 7.2 + Nginx + Docker です。</p><h2 id=preparation>Preparation</h2><p>事前に必要そうな設定を行っていきます。</p><h3 id=firewall>Firewall</h3><p>ファイヤーウォールの設定をしていきます。</p><p>現在の設定を確認します。</p><pre><code>firewall-cmd --list-all
</code></pre><p>dmzゾーン を default設定 に変更します。</p><pre><code>firewall-cmd --set-default-zone=dmz
</code></pre><p>次にNICへ割り当てられているゾーンの変更します。
<code>/etc/sysconfig/network-scripts/ifcfg-eth0</code> の最終行に <code>ZONE=dmz</code> を追加しただけです。</p><pre><code class=language-diff:/etc/sysconfig/network-scripts/ifcfg-eth0 data-lang=diff:/etc/sysconfig/network-scripts/ifcfg-eth0>+ ZONE=dmz
</code></pre><p>http と https 用のポートを開け設定を読み込ませます。
<code>--permanent</code> をつけることによって永続化させることができます。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>firewall-cmd --permanent --add-service<span style=color:#f92672>=</span>http
firewall-cmd --permanent --add-service<span style=color:#f92672>=</span>https
firewall-cmd --reload
</code></pre></div><h3 id=swap-領域>Swap 領域</h3><p>私が借りたサーバーはメモリが 1GB と貧弱なので Swap 領域を 4G 設定しました。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>dd <span style=color:#66d9ef>if</span><span style=color:#f92672>=</span>/dev/zero of<span style=color:#f92672>=</span>/swapfile bs<span style=color:#f92672>=</span>1M count<span style=color:#f92672>=</span><span style=color:#ae81ff>4096</span>
chmod <span style=color:#ae81ff>600</span> /swapfile
mkswap /swapfile
swapon /swapfile
</code></pre></div><h2 id=install--setting>Install ･ Setting</h2><p>必要なものをどんどんインストールしていきます。</p><h3 id=certbot>Certbot</h3><p>SSL証明書(Let’s Encrypt ) を利用するためクライアントソフトをインストールします
<a class=link href=https://certbot.eff.org/#centosrhel7-nginx target=_blank rel=noopener>ここ</a> を参考にしました。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>yum -y install yum-utils
yum-config-manager --enable rhui-REGION-rhel-server-<span style=color:#f92672>{</span>extras,optional<span style=color:#f92672>}</span>
yum -y install certbot
</code></pre></div><p>インストールが終わったら SSL証明書を発行します。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>certbot certonly --standalone -d example.com --rsa-key-size <span style=color:#ae81ff>4096</span>
</code></pre></div><h3 id=nginx>Nginx</h3><p>公開するために Web サーバーをインストールします。
<a class=link href=https://www.nginx.com/resources/wiki/start/topics/tutorials/install/#official-red-hat-centos-packages target=_blank rel=noopener>ここ</a> を参考にしました。</p><p>まず最新版をインストールするために設定ファイルを作成します。</p><pre><code class=language-:/etc/yum.repos.d/nginx.repo data-lang=:/etc/yum.repos.d/nginx.repo>[nginx]
name=nginx repo
baseurl=http://nginx.org/packages/centos/7/$basearch/
gpgcheck=0
enabled=1
</code></pre><p>そして次のコマンドを入力しインストールします。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>yum -y --enablerepo<span style=color:#f92672>=</span>nginx install nginx
</code></pre></div><p>最後に、 Nginx の起動とサーバの再起動が行われた場合でも自動で起動されるように設定します。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>systemctl enable nginx
systemctl start nginx
</code></pre></div><h3 id=docker>Docker</h3><p>Mastodon を簡単に動かすために仮想化ソフトをインストールします。
<a class=link href=https://docs.docker.com/engine/installation/linux/centos/#docker-ce target=_blank rel=noopener>ここ</a> を参考にしました。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
yum -y install docker-ce
</code></pre></div><p>Docker の起動とサーバの再起動が行われた場合でも自動で起動されるように設定します。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>systemctl enable docker
systemctl start docker
</code></pre></div><h4 id=docker-compose>Docker Compose</h4><p>複数のコンテナからなるサービス (ここでは Mastodon のことです) を簡単に操作できるように Docker Compose をインストールします。
<a class=link href=https://docs.docker.com/compose/install/ target=_blank rel=noopener>ここ</a> を参考にしました。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl -L https://github.com/docker/compose/releases/download/1.14.0/docker-compose-<span style=color:#66d9ef>$(</span>uname -s<span style=color:#66d9ef>)</span>-<span style=color:#66d9ef>$(</span>uname -m<span style=color:#66d9ef>)</span> &gt; /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose
</code></pre></div><p>Docker Compose が動くか確認します。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker-compose --version
</code></pre></div><h3 id=mastodon>Mastodon</h3><p><a class=link href=https://github.com/tootsuite/documentation/blob/master/Running-Mastodon/Docker-Guide.md target=_blank rel=noopener>ここ</a> を参考にしました。
今回インストールするディレクトリは <code>/var/www/mstdn</code> とします。</p><p>まず、操作するためのユーザーを作成します</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>useradd --system --user-group --shell /bin/false --create-home --home /home/mastodon mastodon
passwd mastodon
</code></pre></div><p>Mastodonをインストールする場所を用意し所有者を変更します。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mkdir -p /var/www/mstdn
chown -R mastodon /var/www/mstdn
</code></pre></div><p>ここからユーザーを変えてMastodonをインストールします。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>su - mastodon
cd /var/www
git clone https://github.com/tootsuite/mastodon.git mstdn
cd /var/www/mstdn
sudo docker-compose build
</code></pre></div><p>設定ファイルをコピーして書き換えていきます。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cp .env.production.sample .env.production
</code></pre></div><p>3回シークレットキーを生成しメモを取ります。
生成したのはシークレットキーは <code>PAPERCLIP_SECRET</code> と <code>SECRET_KEY_BASE</code> と <code>OTP_SECRET</code> の部分を書き直します。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo docker-compose run --rm web rake secret
</code></pre></div><p>あとは必要に応じて <code>LOCAL_DOMAIN</code> や <code>SMTP_*</code> の部分を書き直します。</p><p>Mastodonを使用して感じたのは、自インスタンスにいるユーザーがリモートフォローしてる人が投稿した画像も自分のインスタンスに保存されるので絵師などをフォローしてるとすぐに容量がなくなります。なのでS3の項目も設定した方がおすすめです。</p><pre><code class=language-zsh:.env.production(設定例) data-lang=zsh:.env.production(設定例)># S3 (optional)
S3_ENABLED=true
S3_BUCKET=&lt;バケット名&gt;
AWS_ACCESS_KEY_ID=&lt;AWSのアクセスキー&gt;
AWS_SECRET_ACCESS_KEY=&lt;AWSのシークレットキー&gt;
S3_REGION=ap-northeast-1
S3_PROTOCOL=https
S3_HOSTNAME=https://ap-northeast-1.amazonaws.com

# Optional alias for S3 if you want to use Cloudfront or Cloudflare in front
S3_CLOUDFRONT_HOST=&lt;S3のバケットドメインかCDNのドメイン&gt;
</code></pre><p>このままDockerを起動するとデータが消えるので <code>docker-compose.yml</code> を編集します。
<code>Uncomment to enable ...</code>と書いてある下の<code>volumes</code>の部分をコメントアウトします。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff:docker-compose.yml data-lang=diff:docker-compose.yml> <span style=color:#75715e>### Uncomment to enable DB persistance</span>
<span style=color:#f92672>-#    volumes</span>:
-<span style=color:#75715e>#      - ./postgres:/var/lib/postgresql/data</span>
<span style=color:#f92672>+    volumes</span>:
<span style=color:#ae81ff>+      - ./postgres:/var/lib/postgresql/data</span>
 
   <span style=color:#f92672>redis</span>:
     <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
     <span style=color:#f92672>image</span>: <span style=color:#ae81ff>redis:alpine</span>
 <span style=color:#75715e>### Uncomment to enable REDIS persistance</span>
<span style=color:#f92672>-#    volumes</span>:
-<span style=color:#75715e>#      - ./redis:/data</span>
<span style=color:#f92672>+    volumes</span>:
<span style=color:#ae81ff>+      - ./redis:/data</span>
</code></pre></div><h4 id=postgresql-のバージョンを固定化>PostgreSQL のバージョンを固定化</h4><p>このままでは PostgreSQL のメインバージョンがアップデートされるとアップグレード作業をする必要が発生するのでバージョンを固定します。
(<a class=link href=http://cryks.hateblo.jp/entry/2017/04/16/145547 target=_blank rel=noopener>ここ</a> を参考にしました)</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff:docker-compose.yml data-lang=diff:docker-compose.yml>-    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>postgres:alpine</span>
<span style=color:#f92672>+    image</span>: <span style=color:#ae81ff>postgres:9.6-alpin</span>
</code></pre></div><h4 id=sidekiq-を冗長化する-オプション>Sidekiq を冗長化する (オプション)</h4><p>Pawoo.net を運用してる pixiv で <a class=link href=https://inside.pixiv.blog/harukasan/1284 target=_blank rel=noopener>実際に運用してみてわかった、大規模Mastodonインスタンスを運用するコツ</a> という記事を見つけ読みました。</p><blockquote><p>このうちpush、pullのキューは他のMastodonインスタンスのAPIをリクエストする必要があるため、ほかのMastodonインスタンスが応答できない状態に陥っているとかなりのキューが詰まれてしまい、defaultキューの処理も遅延させてしまいます。</p></blockquote><p>とあり具体的な解決策として <strong>Sidekiqのプロセス数を増やす</strong> と書いてあったのでDockerを複数立てて対応して見ました。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml:docker-compose.yml data-lang=yaml:docker-compose.yml>  <span style=color:#f92672>sidekiq-default</span>:
    <span style=color:#f92672>build</span>: <span style=color:#ae81ff>.</span>
    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>gargron/mastodon</span>
    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
    <span style=color:#f92672>env_file</span>: <span style=color:#ae81ff>.env.production</span>
    <span style=color:#f92672>command</span>: <span style=color:#ae81ff>bundle exec sidekiq -c 20 -q default</span>
    <span style=color:#f92672>depends_on</span>:
      - <span style=color:#ae81ff>db</span>
      - <span style=color:#ae81ff>redis</span>
    <span style=color:#f92672>volumes</span>:
      - <span style=color:#ae81ff>./public/system:/mastodon/public/system</span>

  <span style=color:#f92672>sidekiq-maile</span>:
    <span style=color:#f92672>build</span>: <span style=color:#ae81ff>.</span>
    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>gargron/mastodon</span>
    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
    <span style=color:#f92672>env_file</span>: <span style=color:#ae81ff>.env.production</span>
    <span style=color:#f92672>command</span>: <span style=color:#ae81ff>bundle exec sidekiq -c 5 -q mailers</span>
    <span style=color:#f92672>depends_on</span>:
      - <span style=color:#ae81ff>db</span>
      - <span style=color:#ae81ff>redis</span>
    <span style=color:#f92672>volumes</span>:
      - <span style=color:#ae81ff>./public/system:/mastodon/public/system</span>

  <span style=color:#f92672>sidekiq-pull</span>:
    <span style=color:#f92672>build</span>: <span style=color:#ae81ff>.</span>
    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>gargron/mastodon</span>
    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
    <span style=color:#f92672>env_file</span>: <span style=color:#ae81ff>.env.production</span>
    <span style=color:#f92672>command</span>: <span style=color:#ae81ff>bundle exec sidekiq -c 10 -q pull</span>
    <span style=color:#f92672>depends_on</span>:
      - <span style=color:#ae81ff>db</span>
      - <span style=color:#ae81ff>redis</span>
    <span style=color:#f92672>volumes</span>:
      - <span style=color:#ae81ff>./public/system:/mastodon/public/system</span>

  <span style=color:#f92672>sidekiq-push</span>:
    <span style=color:#f92672>build</span>: <span style=color:#ae81ff>.</span>
    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>gargron/mastodon</span>
    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
    <span style=color:#f92672>env_file</span>: <span style=color:#ae81ff>.env.production</span>
    <span style=color:#f92672>command</span>: <span style=color:#ae81ff>bundle exec sidekiq -c 15 -q push</span>
    <span style=color:#f92672>depends_on</span>:
      - <span style=color:#ae81ff>db</span>
      - <span style=color:#ae81ff>redis</span>
    <span style=color:#f92672>volumes</span>:
      - <span style=color:#ae81ff>./public/system:/mastodon/public/system</span>
</code></pre></div><h3 id=セットアップ>セットアップ</h3><p>下記のコマンドでデータベースや必要なファイルのセットアップを行います。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo docker-compose run --rm web rails db:setup
sudo docker-compose run --rm web rails assets:precompile
</code></pre></div><p>最後にMastodonを起動させます</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo docker-compose up -d
</code></pre></div><p>これでローカルに Mastodon を建てることができました。</p><h4 id=nginx-の設定>Nginx の設定</h4><p>Mastodonを外部に公開するためにWebサーバーの設定をします。
<a class=link href=https://git.io/v9AaO target=_blank rel=noopener>ここ</a> を参考に <code>/etc/nginx/conf.d/mastodon.conf</code> を作成しました。</p><p>HSTS の設定を追記します。</p><pre><code class=language-diff:/etc/nginx/conf.d/mastodon.conf data-lang=diff:/etc/nginx/conf.d/mastodon.conf>-	add_header Strict-Transport-Security &quot;max-age=31536000&quot;;
+	add_header Strict-Transport-Security &quot;max-age=31536000; includeSubDomains; preload&quot;;
</code></pre><p>このまま起動しようとすると <code>ssl_dhparam</code> で指定してるファイルがないと怒られるので作成します。
環境によってはすごい時間がかかるので注意してください。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo openssl dhparam -out /etc/ssl/certs/dhparam.pem <span style=color:#ae81ff>4096</span>
</code></pre></div><p>Nginxと念の為にMastodonを再起動させたら完了です</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo docker-compose restart
sudo systemctl restart nginx
</code></pre></div><p>お疲れ様です。これでサーバーを立てることができたと思います。</p><h2 id=update>Update</h2><ol><li>リモートリポジトリの最新の履歴の取得します。<ul><li><code>git fetch --tags</code></li></ul></li><li>最新のTagに変更する (例: v1.6.1 にする場合)<ul><li><code>git checkout v1.6.1</code></li></ul></li><li>確認<ul><li><code>git status</code></li></ul></li><li>ビルド<ul><li><code>docker-compose build</code></li></ul></li><li>DB (Option)<ul><li><code>docker-compose run --rm web rake db:migrate</code></li></ul></li><li>(Option)<ul><li><code>docker-compose run --rm web rake assets:precompile</code></li></ul></li><li>再起動<ul><li><code>docker-compose up -d</code></li></ul></li></ol><p>これで再起動ができてると思われます。</p><h2 id=さいごに>さいごに</h2><p>色々と書きましたが今は違う構成をしてたりしてるのであくまでも参考程度にお願いします。</p></section><footer class=article-footer><section class=article-tags><a href=https://www.39.gy/tags/mastodon/>Mastodon</a>
<a href=https://www.39.gy/tags/centos/>Cent o s</a>
<a href=https://www.39.gy/tags/docker/>Docker</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section><section class=article-time><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><span class=article-time--modified></span></section></footer></article><aside class="widget related-contents--wrapper"><h1 class=widget-title>Related contents</h1><div class=related-contents><div class="flex article-list--tile"><article class=has-image><a href=https://www.39.gy/post/docker-secure/><div class=article-image><img src=https://res.cloudinary.com/dagsofv2s/image/upload/q_auto:good/blog/post/docker-secure/thumbnail.png loading=lazy data-key data-hash=https://res.cloudinary.com/dagsofv2s/image/upload/q_auto:good/blog/post/docker-secure/thumbnail.png></div><div class=article-details><h2 class=article-title>Docker をセキュアに使うために</h2></div></a></article><article class=has-image><a href=https://www.39.gy/post/mastodon-customize/><div class=article-image><img src=https://res.cloudinary.com/dagsofv2s/image/upload/q_auto:good/blog/post/mastodon-customize/thumbnail.png loading=lazy data-key data-hash=https://res.cloudinary.com/dagsofv2s/image/upload/q_auto:good/blog/post/mastodon-customize/thumbnail.png></div><div class=article-details><h2 class=article-title>Mastodon をカスタマイズする</h2></div></a></article><article class=has-image><a href=https://www.39.gy/post/mastodon-conoha/><div class=article-image><img src=https://res.cloudinary.com/dagsofv2s/image/upload/q_auto:good/blog/post/mastodon-conoha/thumbnail.png loading=lazy data-key data-hash=https://res.cloudinary.com/dagsofv2s/image/upload/q_auto:good/blog/post/mastodon-conoha/thumbnail.png></div><div class=article-details><h2 class=article-title>ConoHa で Mastodon を立ててみた (テンプレート使用)</h2></div></a></article><article class=has-image><a href=https://www.39.gy/post/ci-chenge/><div class=article-image><img src=https://res.cloudinary.com/dagsofv2s/image/upload/q_auto:good/blog/post/ci-chenge/thumbnail.png loading=lazy data-key data-hash=https://res.cloudinary.com/dagsofv2s/image/upload/q_auto:good/blog/post/ci-chenge/thumbnail.png></div><div class=article-details><h2 class=article-title>ブログのビルドをCircleCIからGitHub Actionsに変更した</h2></div></a></article><article class=has-image><a href=https://www.39.gy/post/paclist-v1/><div class=article-image><img src=https://res.cloudinary.com/dagsofv2s/image/upload/q_auto:good/blog/post/paclist-v1/thumbnail.png loading=lazy data-key data-hash=https://res.cloudinary.com/dagsofv2s/image/upload/q_auto:good/blog/post/paclist-v1/thumbnail.png></div><div class=article-details><h2 class=article-title>Arch Linux パッケージを選定した</h2></div></a></article></div></div></aside><script src=https://utteranc.es/client.js repo=ress997/blog-comment issue-term=pathname theme=preferred-color-scheme crossorigin=anonymous async></script><style>.utterances{max-width:unset}</style><footer class=site-footer><section class=copyright>&copy; 2020 39.gy</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=1.0.4>Stack</a></b> designed by
<a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true style=display:none><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const customFont=document.createElement('link');customFont.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";customFont.type="text/css";customFont.rel="stylesheet";document.head.appendChild(customFont);}());</script><link rel=stylesheet href=/css/highlight/light.min.css media="(prefers-color-scheme: light)"><link rel=stylesheet href=/css/highlight/dark.min.css media="(prefers-color-scheme: dark)"></body></html>